kind: BotDefinition
entity:
  accessControlPolicy: ChatbotReaders
  authenticationMode: Integrated
  authenticationTrigger: Always
  configuration:
    settings:
      GenerativeActionsEnabled: true

  template: RetailAgentTemplate-1.0.0

components:
  # ============================================
  # TOPIC: Saludo
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: true

    displayName: Saludo
    description: Mensaje de bienvenida para el agente de retail
    shareContext: {}
    state: Active
    status: Active
    schemaName: template-content.topic.Saludo
    dialog:
      beginDialog:
        kind: OnRecognizedIntent
        id: main
        intent:
          displayName: Saludo
          includeInOnSelectIntent: false
          triggerQueries:
            - hola
            - buenos d√≠as
            - buenas tardes
            - buenas noches
            - qu√© tal
            - saludos
            - hey
            - holi

        actions:
          - kind: SendActivity
            id: sendMessage_greeting
            activity:
              text:
                - ¬°Bienvenido a nuestra tienda! Soy tu asistente virtual de ventas. Estoy aqu√≠ para ayudarte con informaci√≥n sobre productos, precios, inventario y m√°s.
              speak:
                - Bienvenido a nuestra tienda. ¬øEn qu√© puedo ayudarte hoy?

          - kind: SendActivity
            id: sendMessage_options
            activity:
              attachmentLayout: carousel
              attachments:
                - contentType: application/vnd.microsoft.card.hero
                  content:
                    title: Ver Productos
                    text: Explora nuestro cat√°logo
                    buttons:
                      - type: imBack
                        title: Ver productos
                        value: quiero ver productos

                - contentType: application/vnd.microsoft.card.hero
                  content:
                    title: Verificar Inventario
                    text: Consulta disponibilidad
                    buttons:
                      - type: imBack
                        title: Verificar stock
                        value: verificar inventario

                - contentType: application/vnd.microsoft.card.hero
                  content:
                    title: Consultar Precios
                    text: Informaci√≥n de precios
                    buttons:
                      - type: imBack
                        title: Ver precios
                        value: consultar precio

  # ============================================
  # TOPIC: Consulta de Productos
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: true

    displayName: Consulta de Productos
    description: Permite consultar informaci√≥n sobre productos disponibles
    shareContext: {}
    state: Active
    status: Active
    schemaName: template-content.topic.ProductInquiry
    dialog:
      beginDialog:
        kind: OnRecognizedIntent
        id: main
        intent:
          displayName: Consulta de Productos
          includeInOnSelectIntent: true
          triggerQueries:
            - quiero ver productos
            - mostrar productos
            - qu√© productos tienen
            - ver cat√°logo
            - productos disponibles
            - buscar producto

        actions:
          - kind: SendActivity
            id: sendMessage_intro
            activity: Por supuesto, puedo ayudarte a encontrar el producto perfecto. ¬øQu√© categor√≠a te interesa?

          - kind: Question
            id: question_category
            variable: Topic.ProductCategory
            prompt: Selecciona una categor√≠a (Electr√≥nica, Ropa, Hogar, Deportes, Juguetes, Belleza, Alimentos)
            entity: StringPrebuiltEntity

          - kind: SendActivity
            id: sendMessage_result
            activity: Excelente elecci√≥n. Te mostrar√© nuestros productos de {Topic.ProductCategory}. ¬øNecesitas m√°s informaci√≥n sobre alg√∫n producto espec√≠fico?

  # ============================================
  # TOPIC: Verificar Inventario
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: true

    displayName: Verificar Inventario
    description: Verifica la disponibilidad de productos en las tiendas
    shareContext: {}
    state: Active
    status: Active
    schemaName: template-content.topic.CheckInventory
    dialog:
      beginDialog:
        kind: OnRecognizedIntent
        id: main
        intent:
          displayName: Verificar Inventario
          includeInOnSelectIntent: true
          triggerQueries:
            - verificar inventario
            - hay stock
            - disponibilidad
            - tienen en stock
            - est√° disponible

        actions:
          - kind: Question
            id: question_product
            variable: Topic.ProductName
            prompt: ¬øQu√© producto te gustar√≠a verificar?
            entity: StringPrebuiltEntity

          - kind: Question
            id: question_inventory_location
            variable: Topic.StoreLocation
            prompt: ¬øEn qu√© tienda deseas verificar? (Por ejemplo: Centro, Norte, Sur, Este, Oeste, Online)
            entity: StringPrebuiltEntity

          - kind: SendActivity
            id: sendMessage_checking
            activity: Verificando disponibilidad de {Topic.ProductName} en {Topic.StoreLocation}...

          - kind: SendActivity
            id: sendMessage_result
            activity: El producto est√° disponible en {Topic.StoreLocation}. ¬øTe gustar√≠a conocer el precio o hacer alguna otra consulta?

  # ============================================
  # TOPIC: Informaci√≥n de Precios (con Cloud Flow)
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: true

    displayName: Informaci√≥n de Precios
    description: Proporciona informaci√≥n sobre precios y env√≠a cotizaci√≥n por email
    shareContext: {}
    state: Active
    status: Active
    schemaName: template-content.topic.PricingInfo
    dialog:
      beginDialog:
        kind: OnRecognizedIntent
        id: main
        intent:
          displayName: Informaci√≥n de Precios
          includeInOnSelectIntent: true
          triggerQueries:
            - cu√°nto cuesta
            - precio
            - consultar precio
            - valor
            - qu√© precio tiene
            - cotizaci√≥n
            - cotizar

        actions:
          - kind: Question
            id: question_product
            variable: Topic.ProductForPrice
            prompt: ¬øDe qu√© producto deseas conocer el precio?
            entity: StringPrebuiltEntity

          - kind: Question
            id: question_customer_name
            variable: Topic.CustomerName
            prompt: Para enviarte una cotizaci√≥n detallada, ¬øcu√°l es tu nombre?
            entity: StringPrebuiltEntity

          - kind: Question
            id: question_customer_email
            variable: Topic.CustomerEmail
            prompt: ¬øCu√°l es tu email?
            entity: StringPrebuiltEntity

          - kind: Question
            id: question_store_location
            variable: Topic.StoreLocation
            prompt: ¬øEn qu√© tienda prefieres recoger el producto? (Por ejemplo: Centro, Norte, Sur, Este, Oeste, Online)
            entity: StringPrebuiltEntity

          - kind: SendActivity
            id: sendMessage_processing
            activity: Perfecto, estoy enviando tu solicitud al equipo de ventas...

          - kind: InvokeFlowAction
            id: invoke_email_flow
            flowId: "ADD36A2B-9BBB-F011-BBD2-000D3A36E147"
            input:
              binding:
                text: =Topic.ProductForPrice
                text_1: =Topic.CustomerName
                email: =Topic.CustomerEmail
                text_2: =Topic.StoreLocation
            output: Topic.FlowResponse

          - kind: SendActivity
            id: send_confirmation
            activity: |
              ‚úì {Topic.FlowResponse.ConfirmationMessage}
              
              üìß Recibir√°s la cotizaci√≥n en {Topic.CustomerEmail}
              üìù Tu n√∫mero de referencia es: {Topic.FlowResponse.ReferenceNumber}
              
              El equipo de ventas te contactar√° pronto con los mejores precios y promociones disponibles.
              
              ¬øHay algo m√°s en lo que pueda ayudarte?

  # ============================================
  # TOPIC: Ubicaciones de Tiendas
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: true

    displayName: Ubicaciones de Tiendas
    description: Muestra las direcciones y horarios de nuestras tiendas
    shareContext: {}
    state: Active
    status: Active
    schemaName: template-content.topic.StoreLocations
    dialog:
      beginDialog:
        kind: OnRecognizedIntent
        id: main
        intent:
          displayName: Ubicaciones de Tiendas
          includeInOnSelectIntent: true
          triggerQueries:
            - d√≥nde est√°n ubicados
            - ubicaci√≥n de tienda
            - direcci√≥n
            - sucursales
            - tiendas f√≠sicas

        actions:
          - kind: SendActivity
            id: sendMessage_stores
            activity: |
              Contamos con las siguientes tiendas:
              
              üìç Tienda Centro - Av. Principal 123
              üìç Tienda Norte - Calle Norte 456
              üìç Tienda Sur - Av. Sur 789
              üìç Tienda Este - Boulevard Este 321
              üìç Tienda Oeste - Calle Oeste 654
              üåê Tienda Online - www.tienda.com

  # ============================================
  # TOPIC: Transferir a Agente Humano
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: true

    displayName: Transferir a Agente Humano
    description: Transfiere la conversaci√≥n a un representante de ventas
    shareContext: {}
    state: Active
    status: Active
    schemaName: template-content.topic.EscalateRetail
    dialog:
      startBehavior: CancelOtherTopics
      beginDialog:
        kind: OnEscalate
        id: main
        intent:
          displayName: Transferir a Agente
          includeInOnSelectIntent: true
          triggerQueries:
            - hablar con agente
            - transferir a humano
            - quiero hablar con alguien
            - atenci√≥n al cliente
            - necesito ayuda personal

        actions:
          - kind: SendActivity
            id: sendMessage_escalate
            conversationOutcome: Escalated
            activity: Entiendo que prefieres hablar con un representante. Te estoy transfiriendo ahora. ¬øHay algo m√°s en lo que pueda ayudarte mientras esperas?

  # ============================================
  # TOPICS DEL SISTEMA
  # ============================================
  - kind: DialogComponent
    managedProperties:
      isCustomizable: false

    displayName: Respuesta Predeterminada
    description: Se activa cuando no se reconoce la consulta del usuario
    shareContext: {}
    state: Active
    status: Active
    publisherUniqueName: DefaultPublisherorgce8fe757
    schemaName: template-content.topic.RespuestaPredeterminada
    dialog:
      beginDialog:
        kind: OnUnknownIntent
        id: main
        actions:
          - kind: ConditionGroup
            id: conditionGroup_fallback
            conditions:
              - id: conditionItem_fallback
                condition: =System.FallbackCount < 3
                actions:
                  - kind: SendActivity
                    id: sendMessage_fallback
                    activity: Lo siento, no entend√≠ tu consulta. ¬øPodr√≠as reformularla? Puedo ayudarte con productos, precios, inventario o ubicaciones de tiendas.

            elseActions:
              - kind: BeginDialog
                id: escalate_fallback
                dialog: template-content.topic.EscalateRetail

  - kind: DialogComponent
    managedProperties:
      isCustomizable: false

    displayName: Inicio de Conversaci√≥n
    description: Se activa al comenzar una nueva conversaci√≥n con el agente
    shareContext: {}
    state: Active
    status: Active
    publisherUniqueName: DefaultPublisherorgce8fe757
    schemaName: template-content.topic.IniciodeConversacion
    dialog:
      beginDialog:
        kind: OnConversationStart
        id: main
        actions:
          - kind: SendActivity
            id: sendMessage_start
            activity:
              text:
                - ¬°Hola! Soy el Asistente Virtual de Retail. Puedo ayudarte con informaci√≥n sobre productos, precios, inventario y ubicaciones de tiendas. ¬øEn qu√© puedo ayudarte hoy?
              speak:
                - Hola y gracias por contactarnos. ¬øC√≥mo puedo ayudarte hoy?

  - kind: DialogComponent
    managedProperties:
      isCustomizable: false

    displayName: Error del Sistema
    description: Se activa cuando el agente encuentra un error durante la conversaci√≥n
    shareContext: {}
    state: Active
    status: Active
    publisherUniqueName: DefaultPublisherorgce8fe757
    schemaName: template-content.topic.ErrordelSistema
    dialog:
      startBehavior: UseLatestPublishedContentAndCancelOtherTopics
      beginDialog:
        kind: OnError
        id: main
        actions:
          - kind: SetVariable
            id: setVariable_timestamp
            variable: init:Topic.CurrentTime
            value: =Text(Now(), DateTimeFormat.UTC)

          - kind: SendActivity
            id: sendMessage_error
            activity: Ha ocurrido un error. Por favor, intenta nuevamente. Si el problema persiste, cont√°ctanos.

          - kind: LogCustomTelemetryEvent
            id: log_error
            eventName: RetailAgentError
            properties: "={ErrorMessage: System.Error.Message, ErrorCode: System.Error.Code, TimeUTC: Topic.CurrentTime, ConversationId: System.Conversation.Id}"

          - kind: CancelAllDialogs
            id: cancel_on_error
